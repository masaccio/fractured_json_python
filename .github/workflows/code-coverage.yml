name: Code coverage
on: [push, workflow_dispatch]
jobs:
  run:
    runs-on: ubuntu-latest
    env:
      OS: ubuntu-latest
      PYTHON: '3.11'
    steps:
      - name: Checkout repo with submodules
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync and update FracturedJson submodule to tip of main
        run: |
          set -euo pipefail
          # Ensure .gitmodules remotes are in sync and initialize submodules
          git submodule sync --recursive
          git submodule update --init --recursive

          # Force FracturedJson to origin/main (robust for shallow clones)
          if [ -d "FracturedJson" ]; then
            pushd FracturedJson
            git fetch --no-tags origin main
            if git rev-parse --verify origin/main >/dev/null 2>&1; then
              git checkout -B main origin/main
              git reset --hard origin/main
            else
              echo "ERROR: origin/main not found for FracturedJson"
              git show-ref || true
              exit 1
            fi
            popd
          else
            echo "ERROR: FracturedJson directory not found after init"
            exit 1
          fi
    
      - name: Install uv and set the python version
        uses: astral-sh/setup-uv@v5
        with:
          python-version: '3.13'

      - name: Install the project
        run: uv sync --locked --all-extras --dev

      - name: Build FracturedJson binaries
        run: uv run python3 src/build/build_binaries.py

      - name: Generate coverage report
        run: uv run pytest --cov=fractured_json --cov-report=xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ./coverage/reports/
          env_vars: OS,PYTHON
          fail_ci_if_error: true
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          verbose: true